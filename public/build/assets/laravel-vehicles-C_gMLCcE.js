document.addEventListener("DOMContentLoaded",function(E){const h=document.querySelector(".datatables-vehicles"),g=document.getElementById("offcanvasAddVehicles"),i=document.getElementById("addNewVehicleForm"),u=document.getElementById("custom-fields-container"),y=document.getElementById("custom-fields-list");function p(c){if(!c||c.length===0){u.classList.add("d-none");return}u.classList.remove("d-none"),y.innerHTML=c.map(a=>{const n=a.current_value||"",l=a.required?"required":"";let e="";if(a.type==="select"){const o=Array.isArray(a.options)?a.options:[];e=`
                    <select name="custom_fields[${a.id}]" class="form-select" ${l}>
                        <option value="">Selecione...</option>
                        ${o.map(t=>`<option value="${t}" ${n==t?"selected":""}>${t}</option>`).join("")}
                    </select>`}else a.type==="textarea"?e=`<textarea name="custom_fields[${a.id}]" class="form-control" rows="2" ${l}>${n}</textarea>`:e=`<input type="${a.type}" name="custom_fields[${a.id}]" class="form-control" value="${n}" ${l} />`;return`
                <div class="col-md-12 mb-3">
                    <label class="form-label">${a.name}</label>
                    ${e}
                </div>
            `}).join("")}var v=$(".select2");v.length&&v.wrap('<div class="position-relative"></div>').select2({placeholder:"Selecione o Cliente",dropdownParent:v.parent()});const b=document.getElementById("add-vehicle-placa");if(b&&b.addEventListener("blur",function(){const c=this.value.replace(/[^a-zA-Z0-9]/g,"");if(c.length>=7){const a=this.placeholder;this.placeholder="Buscando...",fetch(`${baseUrl}api/vehicle-lookup/${c}`).then(n=>n.json()).then(n=>{this.placeholder=a,!n.error&&!n.message&&(n.marca&&(document.getElementById("add-vehicle-marca").value=n.marca),n.modelo&&(document.getElementById("add-vehicle-modelo").value=n.modelo),n.ano&&(document.getElementById("add-vehicle-ano-fabricacao").value=n.ano))}).catch(()=>{this.placeholder=a})}}),h){const c=window.location.pathname.split("/").pop(),a=c+"-list",n=new DataTable(h,{processing:!0,serverSide:!0,ajax:{url:baseUrl+a},columns:[{data:"id"},{data:"id"},{data:"placa"},{data:"marca"},{data:"modelo"},{data:"ano_fabricacao"},{data:"ativo"},{data:"id"}],columnDefs:[{className:"control",orderable:!1,targets:0,render:()=>""},{targets:1,render:(e,o,t)=>`<span>${t.fake_id}</span>`},{targets:2,render:(e,o,t)=>`<a href="javascript:void(0)" class="fw-bold text-primary view-dossier" data-id="${t.id}">${e}</a>`},{targets:6,render:e=>`<span class="badge bg-label-${e?"success":"danger"}">${e?"Sim":"Não"}</span>`},{targets:-1,title:"Ações",orderable:!1,render:(e,o,t)=>`<div class="d-flex align-items-center gap-2"><button class="btn btn-sm btn-icon edit-record" data-id="${t.id}" data-bs-toggle="offcanvas" data-bs-target="#offcanvasAddVehicles"><i class="ti tabler-edit"></i></button><button class="btn btn-sm btn-icon delete-record" data-id="${t.id}"><i class="ti tabler-trash"></i></button></div>`}],order:[[1,"desc"]]});document.addEventListener("click",function(e){if(e.target.closest(".view-dossier")){const o=e.target.closest(".view-dossier").dataset.id;$("#viewDossierModal").modal("show"),$("#dossierModalContent").html('<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>'),fetch(`${baseUrl}${c}/${o}/dossier`).then(t=>t.text()).then(t=>{$("#dossierModalContent").html(t)})}}),document.addEventListener("click",function(e){if(e.target.closest(".delete-record")){const o=e.target.closest(".delete-record").dataset.id;Swal.fire({title:"Remover?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sim, excluir",customClass:{confirmButton:"btn btn-danger me-3",cancelButton:"btn btn-label-secondary"},buttonsStyling:!1}).then(t=>{t.isConfirmed&&fetch(`${baseUrl}${a}/${o}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}).then(()=>n.ajax.reload())})}}),document.addEventListener("click",function(e){if(e.target.closest(".edit-record")){const o=e.target.closest(".edit-record").dataset.id;fetch(`${baseUrl}${a}/${o}/edit`).then(t=>t.json()).then(t=>{const s=t.vehicle;document.getElementById("vehicle_id").value=s.id,document.getElementById("add-vehicle-placa").value=s.placa,document.getElementById("add-vehicle-marca").value=s.marca,document.getElementById("add-vehicle-modelo").value=s.modelo,document.getElementById("add-vehicle-ano-fabricacao").value=s.ano_fabricacao||"",document.getElementById("add-vehicle-renavam").value=s.renavam||"",$("#vehicle-cliente").val(s.cliente_id).trigger("change"),$("#vehicle-status").val(s.ativo?"1":"0"),p(t.custom_fields)})}});const l=document.querySelector(".add-new");l&&l.addEventListener("click",()=>{document.getElementById("vehicle_id").value="",i.reset(),$("#vehicle-cliente").val("").trigger("change"),fetch(`${baseUrl}settings/custom-fields?entity=Vehicles`).then(e=>e.json()).then(e=>{p(e)}).catch(()=>{u.classList.add("d-none")})}),i&&i.addEventListener("submit",function(e){e.preventDefault();const o=new FormData(i);fetch(`${baseUrl}${a}`,{method:"POST",body:o,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content"),Accept:"application/json"}}).then(async t=>{const s=await t.json();t.ok&&s.success?(bootstrap.Offcanvas.getInstance(g).hide(),Swal.fire({icon:"success",title:"Sucesso!",text:s.message,customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}).then(()=>{location.reload()})):(i.querySelectorAll(".is-invalid").forEach(d=>d.classList.remove("is-invalid")),i.querySelectorAll(".invalid-feedback").forEach(d=>d.remove()),s.errors?Object.keys(s.errors).forEach(d=>{const r=i.querySelector(`[name="${d}"]`);if(r){r.classList.add("is-invalid");const m=document.createElement("div");if(m.className="invalid-feedback",m.innerText=s.errors[d][0],r.closest(".input-group"))r.closest(".input-group").after(m);else if(r.classList.contains("select2-hidden-accessible")){const f=r.nextElementSibling;f&&f.classList.contains("select2-container")&&f.after(m)}else r.after(m)}}):Swal.fire({icon:"error",title:"Erro!",text:s.message||"Erro inesperado"}))}).catch(t=>{Swal.fire({icon:"error",title:"Erro!",text:"Ocorreu um erro ao processar a requisição."})})})}});
