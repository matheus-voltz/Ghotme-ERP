document.addEventListener("DOMContentLoaded",function(p){const c=$("#vehicle-search"),d=document.getElementById("btn-add-history"),r=document.getElementById("vehicle-info-card"),m=document.getElementById("timeline-card"),o=document.getElementById("vehicle-timeline"),i=document.getElementById("formAddHistory"),u=document.querySelector(".flatpickr");u&&u.flatpickr({monthSelectorType:"static",dateFormat:"Y-m-d"}),c.length&&c.select2({placeholder:"Digite a Placa ou Chassi...",allowClear:!0,ajax:{url:baseUrl+"vehicle-history/search",dataType:"json",delay:250,data:function(t){return{q:t.term}},processResults:function(t){return{results:t}},cache:!0},minimumInputLength:2}).on("select2:select",function(t){const e=t.params.data;h(e)}).on("select2:clear",function(){y()});function h(t){const e=t.full_data;r.classList.remove("d-none"),m.classList.remove("d-none"),d.disabled=!1,document.getElementById("info-plate").textContent=e.placa,document.getElementById("info-brand-model").textContent=`${e.marca} ${e.modelo}`,document.getElementById("info-owner").textContent=t.client_name,document.getElementById("info-km").textContent=(e.km_atual||0).toLocaleString()+" KM",document.getElementById("info-chassis").textContent=e.chassi||"-",document.getElementById("info-color").textContent=e.cor||"-",document.getElementById("info-year").textContent=e.ano_modelo||e.ano_fabricacao||"-",document.getElementById("modal-vehicle-id").value=e.id,f(e.id)}function f(t){o.innerHTML='<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>',fetch(baseUrl+"vehicle-history/timeline/"+t).then(e=>e.json()).then(e=>{v(e)})}function v(t){if(t.length===0){o.innerHTML='<p class="text-center text-muted py-10">Nenhum registro encontrado para este veículo.</p>';return}let e="";t.forEach(n=>{const a=moment(n.date).format("DD/MM/YYYY");let l="info",s="Registro Manual";n.event_type==="os_finalizada"?(l="success",s="Ordem de Serviço"):n.event_type==="entrada_oficina"&&(l="warning",s="Entrada"),e+=`
                <div class="timeline-item">
                    <div class="timeline-point"></div>
                    <div class="timeline-date">${a} • ${n.km.toLocaleString()} KM</div>
                    <div class="timeline-title d-flex justify-content-between">
                        <span>${n.title}</span>
                        <span class="badge bg-label-${l} ms-2" style="font-size: 0.7rem">${s}</span>
                    </div>
                    <div class="timeline-desc text-muted mb-2">${n.description||""}</div>
                    <div class="timeline-footer d-flex justify-content-between align-items-center">
                        <small>Realizado por: <strong>${n.performer||"Oficina"}</strong></small>
                        ${n.cost?`<small class="fw-medium text-heading">R$ ${parseFloat(n.cost).toFixed(2)}</small>`:""}
                    </div>
                </div>
            `}),o.innerHTML=e}function y(){r.classList.add("d-none"),m.classList.add("d-none"),d.disabled=!0,o.innerHTML='<p class="text-center text-muted py-10">Selecione um veículo para ver o histórico.</p>'}i&&i.addEventListener("submit",function(t){t.preventDefault();const e=new FormData(i);fetch(baseUrl+"vehicle-history",{method:"POST",body:new URLSearchParams(e),headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"Content-Type":"application/x-www-form-urlencoded"}}).then(n=>n.json()).then(n=>{if(n.success){Swal.fire({icon:"success",title:"Sucesso!",text:n.message,customClass:{confirmButton:"btn btn-success"}}),$("#modalAddHistory").modal("hide"),i.reset();const a=document.getElementById("modal-vehicle-id").value;f(a),document.getElementById("info-km").textContent=parseInt(e.get("km")).toLocaleString()+" KM"}})})});
