document.addEventListener("DOMContentLoaded",function(b){const m=document.querySelector(".datatables-vehicles"),f=document.getElementById("offcanvasAddVehicles"),i=document.getElementById("addNewVehicleForm"),l=document.getElementById("custom-fields-container"),h=document.getElementById("custom-fields-list");function u(c){if(!c||c.length===0){l.classList.add("d-none");return}l.classList.remove("d-none"),h.innerHTML=c.map(a=>{const e=a.current_value||"",n=a.required?"required":"";let t="";if(a.type==="select"){const s=Array.isArray(a.options)?a.options:[];t=`
                    <select name="custom_fields[${a.id}]" class="form-select" ${n}>
                        <option value="">Selecione...</option>
                        ${s.map(o=>`<option value="${o}" ${e==o?"selected":""}>${o}</option>`).join("")}
                    </select>`}else a.type==="textarea"?t=`<textarea name="custom_fields[${a.id}]" class="form-control" rows="2" ${n}>${e}</textarea>`:t=`<input type="${a.type}" name="custom_fields[${a.id}]" class="form-control" value="${e}" ${n} />`;return`
                <div class="col-md-12 mb-3">
                    <label class="form-label">${a.name}</label>
                    ${t}
                </div>
            `}).join("")}var r=$(".select2");r.length&&r.wrap('<div class="position-relative"></div>').select2({placeholder:"Selecione o Cliente",dropdownParent:r.parent()});const v=document.getElementById("add-vehicle-placa");if(v&&v.addEventListener("blur",function(){const c=this.value.replace(/[^a-zA-Z0-9]/g,"");if(c.length>=7){const a=this.placeholder;this.placeholder="Buscando...",fetch(`${baseUrl}api/vehicle-lookup/${c}`).then(e=>e.json()).then(e=>{this.placeholder=a,!e.error&&!e.message&&(e.marca&&(document.getElementById("add-vehicle-marca").value=e.marca),e.modelo&&(document.getElementById("add-vehicle-modelo").value=e.modelo),e.ano&&(document.getElementById("add-vehicle-ano-fabricacao").value=e.ano))}).catch(()=>{this.placeholder=a})}}),m){const c=new DataTable(m,{processing:!0,serverSide:!0,ajax:{url:baseUrl+"vehicles-list"},columns:[{data:"id"},{data:"id"},{data:"placa"},{data:"marca"},{data:"modelo"},{data:"ano_fabricacao"},{data:"ativo"},{data:"id"}],columnDefs:[{className:"control",orderable:!1,targets:0,render:()=>""},{targets:1,render:(e,n,t)=>`<span>${t.fake_id}</span>`},{targets:2,render:(e,n,t)=>`<a href="javascript:void(0)" class="fw-bold text-primary view-dossier" data-id="${t.id}">${e}</a>`},{targets:6,render:e=>`<span class="badge bg-label-${e?"success":"danger"}">${e?"Sim":"Não"}</span>`},{targets:-1,title:"Ações",orderable:!1,render:(e,n,t)=>`<div class="d-flex align-items-center gap-2"><button class="btn btn-sm btn-icon edit-record" data-id="${t.id}" data-bs-toggle="offcanvas" data-bs-target="#offcanvasAddVehicles"><i class="ti tabler-edit"></i></button><button class="btn btn-sm btn-icon delete-record" data-id="${t.id}"><i class="ti tabler-trash"></i></button></div>`}],order:[[1,"desc"]]});document.addEventListener("click",function(e){if(e.target.closest(".view-dossier")){const n=e.target.closest(".view-dossier").dataset.id;$("#viewDossierModal").modal("show"),$("#dossierModalContent").html('<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>'),fetch(`${baseUrl}vehicles/${n}/dossier`).then(t=>t.text()).then(t=>{$("#dossierModalContent").html(t)})}}),document.addEventListener("click",function(e){if(e.target.closest(".delete-record")){const n=e.target.closest(".delete-record").dataset.id;Swal.fire({title:"Remover veículo?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sim, excluir",customClass:{confirmButton:"btn btn-danger me-3",cancelButton:"btn btn-label-secondary"},buttonsStyling:!1}).then(t=>{t.isConfirmed&&fetch(`${baseUrl}vehicles-list/${n}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}).then(()=>c.ajax.reload())})}}),document.addEventListener("click",function(e){if(e.target.closest(".edit-record")){const n=e.target.closest(".edit-record").dataset.id;document.getElementById("offcanvasAddVehiclesLabel").innerHTML="Editar Veículo",fetch(`${baseUrl}vehicles-list/${n}/edit`).then(t=>t.json()).then(t=>{const s=t.vehicle;document.getElementById("vehicle_id").value=s.id,document.getElementById("add-vehicle-placa").value=s.placa,document.getElementById("add-vehicle-marca").value=s.marca,document.getElementById("add-vehicle-modelo").value=s.modelo,document.getElementById("add-vehicle-ano-fabricacao").value=s.ano_fabricacao||"",document.getElementById("add-vehicle-renavam").value=s.renavam||"",$("#vehicle-cliente").val(s.cliente_id).trigger("change"),$("#vehicle-status").val(s.ativo?"1":"0"),u(t.custom_fields)})}});const a=document.querySelector(".add-new");a&&a.addEventListener("click",()=>{document.getElementById("vehicle_id").value="",i.reset(),$("#vehicle-cliente").val("").trigger("change"),document.getElementById("offcanvasAddVehiclesLabel").innerHTML="Cadastrar Veículo",fetch(`${baseUrl}settings/custom-fields?entity=Vehicles`).then(e=>e.json()).then(e=>{u(e)}).catch(()=>{l.classList.add("d-none")})})}i&&i.addEventListener("submit",function(c){c.preventDefault();const a=new FormData(i);fetch(`${baseUrl}vehicles-list`,{method:"POST",body:a,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content"),Accept:"application/json"}}).then(async e=>{const n=await e.json();e.ok&&n.success?(bootstrap.Offcanvas.getInstance(f).hide(),Swal.fire({icon:"success",title:"Sucesso!",text:n.message,customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}).then(()=>{location.reload()})):(i.querySelectorAll(".is-invalid").forEach(t=>t.classList.remove("is-invalid")),i.querySelectorAll(".invalid-feedback").forEach(t=>t.remove()),n.errors?Object.keys(n.errors).forEach(t=>{const s=i.querySelector(`[name="${t}"]`);if(s){s.classList.add("is-invalid");const o=document.createElement("div");if(o.className="invalid-feedback",o.innerText=n.errors[t][0],s.closest(".input-group"))s.closest(".input-group").after(o);else if(s.classList.contains("select2-hidden-accessible")){const d=s.nextElementSibling;d&&d.classList.contains("select2-container")&&d.after(o)}else s.after(o)}}):Swal.fire({icon:"error",title:"Erro!",text:n.message||"Erro inesperado"}))}).catch(e=>{Swal.fire({icon:"error",title:"Erro!",text:"Ocorreu um erro ao processar a requisição."})})})});
