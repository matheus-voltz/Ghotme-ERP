document.addEventListener("DOMContentLoaded",function(y){const o=$("#vehicle-search"),d=document.getElementById("btn-add-history"),r=document.getElementById("vehicle-info-card"),m=document.getElementById("timeline-card"),a=document.getElementById("vehicle-timeline"),i=document.getElementById("formAddHistory"),u=document.querySelector(".flatpickr");if(u&&u.flatpickr({monthSelectorType:"static",dateFormat:"Y-m-d"}),o.length){const n=o.data("placeholder")||"Digite a Placa ou Chassi...";o.select2({placeholder:n,allowClear:!0,ajax:{url:baseUrl+"vehicle-history/search",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){return{results:e}},cache:!0},minimumInputLength:2}).on("select2:select",function(e){const t=e.params.data;h(t)}).on("select2:clear",function(){v()})}function h(n){const e=n.full_data;r.classList.remove("d-none"),m.classList.remove("d-none"),d.disabled=!1,document.getElementById("info-plate").textContent=e.placa,document.getElementById("info-brand-model").textContent=`${e.marca} ${e.modelo}`,document.getElementById("info-owner").textContent=n.client_name,document.getElementById("info-km").textContent=(e.km_atual||0).toLocaleString()+" KM",document.getElementById("info-chassis").textContent=e.chassi||"-",document.getElementById("info-color").textContent=e.cor||"-",document.getElementById("info-year").textContent=e.ano_modelo||e.ano_fabricacao||"-",document.getElementById("modal-vehicle-id").value=e.id,f(e.id)}function f(n){a.innerHTML='<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>',fetch(baseUrl+"vehicle-history/timeline/"+n).then(e=>e.json()).then(e=>{p(e)})}function p(n){if(n.length===0){const t=o.data("no-results")||"Nenhum registro encontrado para este veículo.";a.innerHTML=`<p class="text-center text-muted py-10">${t}</p>`;return}let e="";n.forEach(t=>{const l=moment(t.date).format("DD/MM/YYYY");let s="info",c="Registro Manual";t.event_type==="os_finalizada"?(s="success",c="Ordem de Serviço"):t.event_type==="entrada_oficina"&&(s="warning",c="Entrada"),e+=`
                <div class="timeline-item">
                    <div class="timeline-point"></div>
                    <div class="timeline-date">${l} • ${t.km.toLocaleString()} KM</div>
                    <div class="timeline-title d-flex justify-content-between">
                        <span>${t.title}</span>
                        <span class="badge bg-label-${s} ms-2" style="font-size: 0.7rem">${c}</span>
                    </div>
                    <div class="timeline-desc text-muted mb-2">${t.description||""}</div>
                    <div class="timeline-footer d-flex justify-content-between align-items-center">
                        <small>Realizado por: <strong>${t.performer||"Oficina"}</strong></small>
                        ${t.cost?`<small class="fw-medium text-heading">R$ ${parseFloat(t.cost).toFixed(2)}</small>`:""}
                    </div>
                </div>
            `}),a.innerHTML=e}function v(){r.classList.add("d-none"),m.classList.add("d-none"),d.disabled=!0;const n=o.data("select-prompt")||"Selecione um veículo para ver o histórico.";a.innerHTML=`<p class="text-center text-muted py-10">${n}</p>`}i&&i.addEventListener("submit",function(n){n.preventDefault();const e=new FormData(i);fetch(baseUrl+"vehicle-history",{method:"POST",body:new URLSearchParams(e),headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"Content-Type":"application/x-www-form-urlencoded"}}).then(t=>t.json()).then(t=>{if(t.success){Swal.fire({icon:"success",title:"Sucesso!",text:t.message,customClass:{confirmButton:"btn btn-success"}}),$("#modalAddHistory").modal("hide"),i.reset();const l=document.getElementById("modal-vehicle-id").value;f(l),document.getElementById("info-km").textContent=parseInt(e.get("km")).toLocaleString()+" KM"}})})});
