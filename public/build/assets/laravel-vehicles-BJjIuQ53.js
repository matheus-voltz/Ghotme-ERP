document.addEventListener("DOMContentLoaded",function(u){const l=document.querySelector(".datatables-vehicles"),m=document.getElementById("offcanvasAddVehicles"),n=document.getElementById("addNewVehicleForm");var r=$(".select2");if(r.length&&r.wrap('<div class="position-relative"></div>').select2({placeholder:"Selecione o Cliente",dropdownParent:r.parent()}),l){const o=new DataTable(l,{processing:!0,serverSide:!0,ajax:{url:baseUrl+"vehicles-list"},columns:[{data:"id"},{data:"id"},{data:"placa"},{data:"marca"},{data:"modelo"},{data:"ano_fabricacao"},{data:"ativo"},{data:"id"}],columnDefs:[{className:"control",orderable:!1,targets:0,render:()=>""},{targets:1,render:(t,a,e)=>`<span>${e.fake_id}</span>`},{targets:2,render:(t,a,e)=>`<a href="javascript:void(0)" class="fw-bold text-primary view-dossier" data-id="${e.id}">${t}</a>`},{targets:6,render:t=>`<span class="badge bg-label-${t?"success":"danger"}">${t?"Sim":"Não"}</span>`},{targets:-1,title:"Ações",orderable:!1,render:(t,a,e)=>`<div class="d-flex align-items-center gap-2"><button class="btn btn-sm btn-icon edit-record" data-id="${e.id}" data-bs-toggle="offcanvas" data-bs-target="#offcanvasAddVehicles"><i class="ti tabler-edit"></i></button><button class="btn btn-sm btn-icon delete-record" data-id="${e.id}"><i class="ti tabler-trash"></i></button></div>`}],order:[[1,"desc"]]});document.addEventListener("click",function(t){if(t.target.closest(".view-dossier")){const a=t.target.closest(".view-dossier").dataset.id;$("#viewDossierModal").modal("show"),$("#dossierModalContent").html('<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>'),fetch(`${baseUrl}vehicles/${a}/dossier`).then(e=>e.text()).then(e=>{$("#dossierModalContent").html(e)})}}),document.addEventListener("click",function(t){if(t.target.closest(".delete-record")){const a=t.target.closest(".delete-record").dataset.id;Swal.fire({title:"Remover veículo?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sim, excluir",customClass:{confirmButton:"btn btn-danger me-3",cancelButton:"btn btn-label-secondary"},buttonsStyling:!1}).then(e=>{e.isConfirmed&&fetch(`${baseUrl}vehicles-list/${a}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}).then(()=>o.ajax.reload())})}}),document.addEventListener("click",function(t){if(t.target.closest(".edit-record")){const a=t.target.closest(".edit-record").dataset.id;document.getElementById("offcanvasAddVehiclesLabel").innerHTML="Editar Veículo",fetch(`${baseUrl}vehicles-list/${a}/edit`).then(e=>e.json()).then(e=>{document.getElementById("vehicle_id").value=e.id,document.getElementById("add-vehicle-placa").value=e.placa,document.getElementById("add-vehicle-marca").value=e.marca,document.getElementById("add-vehicle-modelo").value=e.modelo,document.getElementById("add-vehicle-ano-fabricacao").value=e.ano_fabricacao||"",document.getElementById("add-vehicle-renavam").value=e.renavam||"",$("#vehicle-cliente").val(e.cliente_id).trigger("change"),$("#vehicle-status").val(e.ativo?"1":"0")})}});const c=document.querySelector(".add-new");c&&c.addEventListener("click",()=>{document.getElementById("vehicle_id").value="",n.reset(),$("#vehicle-cliente").val("").trigger("change"),document.getElementById("offcanvasAddVehiclesLabel").innerHTML="Cadastrar Veículo"})}n&&n.addEventListener("submit",function(o){o.preventDefault();const c=new FormData(n);fetch(`${baseUrl}vehicles-list`,{method:"POST",body:c,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content"),Accept:"application/json"}}).then(async t=>{const a=await t.json();t.ok&&a.success?(bootstrap.Offcanvas.getInstance(m).hide(),Swal.fire({icon:"success",title:"Sucesso!",text:a.message,customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}).then(()=>{location.reload()})):(n.querySelectorAll(".is-invalid").forEach(e=>e.classList.remove("is-invalid")),n.querySelectorAll(".invalid-feedback").forEach(e=>e.remove()),a.errors?Object.keys(a.errors).forEach(e=>{const s=n.querySelector(`[name="${e}"]`);if(s){s.classList.add("is-invalid");const i=document.createElement("div");if(i.className="invalid-feedback",i.innerText=a.errors[e][0],s.closest(".input-group"))s.closest(".input-group").after(i);else if(s.classList.contains("select2-hidden-accessible")){const d=s.nextElementSibling;d&&d.classList.contains("select2-container")&&d.after(i)}else s.after(i)}}):Swal.fire({icon:"error",title:"Erro!",text:a.message||"Erro inesperado"}))}).catch(t=>{Swal.fire({icon:"error",title:"Erro!",text:"Ocorreu um erro ao processar a requisição."})})})});
