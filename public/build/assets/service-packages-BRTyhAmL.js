document.addEventListener("DOMContentLoaded",function(f){const m=document.querySelector(".datatables-packages"),p=document.getElementById("offcanvasPackage"),c=document.getElementById("formPackage"),g=$("#add-part-select"),u=document.getElementById("selected-parts-list");if($(".select2").each(function(){var r=$(this);r.wrap('<div class="position-relative"></div>').select2({dropdownParent:r.parent(),placeholder:r.attr("placeholder")||"Selecione"})}),m){let r=function(e,s,t){if(document.getElementById(`part-row-${e}`))return;const a=document.createElement("div");a.id=`part-row-${e}`,a.className="d-flex align-items-center mb-2 gap-2 border p-2 rounded",a.innerHTML=`
                <input type="hidden" name="parts[]" value="${e}">
                <div class="flex-grow-1"><small>${s}</small></div>
                <div style="width: 80px">
                    <input type="number" name="parts_qty[${e}]" class="form-control form-control-sm" value="${t}" min="1">
                </div>
                <button type="button" class="btn btn-sm btn-icon text-danger remove-part"><i class="ti tabler-x"></i></button>
            `,u.appendChild(a)};var v=r;new DataTable(m,{processing:!0,serverSide:!0,ajax:{url:baseUrl+"services/packages-list"},columns:[{data:"fake_id"},{data:"name"},{data:"id"},{data:"total_price"},{data:"is_active"},{data:"action"}],columnDefs:[{targets:1,render:function(e){return`<span class="fw-medium text-heading">${e}</span>`}},{targets:2,render:function(e,s,t){return`<small>${t.services_count} serv. / ${t.parts_count} peças</small>`}},{targets:3,render:function(e){return e?`R$ ${parseFloat(e).toFixed(2)}`:'<span class="text-muted">Calculado</span>'}},{targets:4,className:"text-center",render:function(e){return e?'<span class="badge bg-label-success">Ativo</span>':'<span class="badge bg-label-danger">Inativo</span>'}},{targets:5,title:"Ações",orderable:!1,render:function(e,s,t){return`<div class="d-flex align-items-center gap-2"><button class="btn btn-sm btn-icon edit-record" data-id="${t.id}" data-bs-toggle="offcanvas" data-bs-target="#offcanvasPackage"><i class="ti tabler-edit"></i></button><button class="btn btn-sm btn-icon delete-record" data-id="${t.id}"><i class="ti tabler-trash"></i></button></div>`}}],layout:{topEnd:{features:[{search:{placeholder:"Procurar pacote"}},{buttons:[{text:'<i class="ti tabler-plus me-1"></i> Criar Pacote',className:"add-new btn btn-primary",attr:{"data-bs-toggle":"offcanvas","data-bs-target":"#offcanvasPackage"}}]}]}}}),g.on("select2:select",function(e){const s=e.params.data.id,t=$(e.params.data.element).data("name");s&&(r(s,t,1),g.val(null).trigger("change"))}),document.addEventListener("click",function(e){e.target.closest(".remove-part")&&e.target.closest(".remove-part").parentElement.remove()}),document.addEventListener("click",function(e){if(e.target.closest(".edit-record")){const s=e.target.closest(".edit-record").dataset.id;document.getElementById("offcanvasPackageLabel").innerHTML="Editar Pacote",u.innerHTML="",fetch(`${baseUrl}services/packages/${s}/edit`).then(t=>t.json()).then(t=>{document.getElementById("package_id").value=t.id,document.getElementById("package-name").value=t.name,document.getElementById("package-total-price").value=t.total_price||"",document.getElementById("package-description").value=t.description||"";const a=t.services.map(n=>n.id);$("#package-services").val(a).trigger("change"),t.parts.forEach(n=>{r(n.id,n.name,n.pivot.quantity)})})}});const d=document.querySelector(".add-new");d&&d.addEventListener("click",function(){document.getElementById("package_id").value="",document.getElementById("offcanvasPackageLabel").innerHTML="Novo Pacote",c.reset(),$("#package-services").val(null).trigger("change"),u.innerHTML=""})}c&&c.addEventListener("submit",function(r){r.preventDefault();const d=new FormData(c),e=d.get("id"),s=e?`${baseUrl}services/packages/${e}`:`${baseUrl}services/packages`;fetch(s,{method:e?"PUT":"POST",body:new URLSearchParams(d),headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"Content-Type":"application/x-www-form-urlencoded"}}).then(async a=>{const n=await a.json();if(!a.ok){if(a.status===422&&n.errors){c.querySelectorAll(".is-invalid").forEach(i=>i.classList.remove("is-invalid")),c.querySelectorAll(".invalid-feedback").forEach(i=>i.remove()),Object.keys(n.errors).forEach(i=>{const o=c.querySelector(`[name="${i}"]`);if(o){o.classList.add("is-invalid");const l=document.createElement("div");l.className="invalid-feedback",l.innerText=n.errors[i][0],o.nextElementSibling&&o.nextElementSibling.classList.contains("select2-container")?o.nextElementSibling.after(l):o.after(l)}});return}throw new Error(n.message||"Erro inesperado")}bootstrap.Offcanvas.getInstance(p).hide(),new DataTable(m).draw(),Swal.fire({icon:"success",title:"Sucesso!",text:n.message,customClass:{confirmButton:"btn btn-success"}})}).catch(a=>{a.message&&Swal.fire({icon:"error",title:"Erro!",text:a.message,customClass:{confirmButton:"btn btn-primary"}})})})});
