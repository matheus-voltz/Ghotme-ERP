document.addEventListener("DOMContentLoaded",function(p){const v=document.querySelector(".datatables-clients"),b=document.getElementById("offcanvasAddClients"),i=document.getElementById("addNewClientsForm"),d=document.getElementById("sectionPF"),r=document.getElementById("sectionPJ");if(document.querySelectorAll(".client-type-toggle").forEach(m=>{m.addEventListener("change",function(){this.value==="PF"?(d.classList.remove("d-none"),r.classList.add("d-none")):(d.classList.add("d-none"),r.classList.remove("d-none"))})}),v){const m=new DataTable(v,{processing:!0,serverSide:!0,ajax:{url:baseUrl+"clients-list"},columns:[{data:"id"},{data:"id"},{data:"type"},{data:"name"},{data:"document"},{data:"email"},{data:"vehicles_count"},{data:"action"}],columnDefs:[{className:"control",orderable:!1,targets:0,render:()=>""},{targets:2,render:t=>`<span class="badge bg-label-${t==="PF"?"success":"info"}">${t}</span>`},{targets:3,render:(t,n,e)=>`
                            <div class="d-flex flex-column">
                                <span class="fw-medium text-heading">${t}</span>
                                <small class="text-muted">${e.whatsapp||"-"}</small>
                            </div>
                        `},{targets:6,render:t=>`<span class="badge rounded-pill bg-label-primary">${t} veículos</span>`},{targets:7,title:"Ações",orderable:!1,render:(t,n,e)=>{const s=e.whatsapp?`https://api.whatsapp.com/send?phone=55${e.whatsapp.replace(/\D/g,"")}`:"#";return'<div class="d-flex align-items-center gap-2">'+(e.whatsapp?`<a href="${s}" target="_blank" class="btn btn-sm btn-icon text-success" title="WhatsApp"><i class="ti tabler-brand-whatsapp"></i></a>`:"")+`<button class="btn btn-sm btn-icon view-record" data-id="${e.id}"><i class="ti tabler-eye"></i></button><button class="btn btn-sm btn-icon edit-record" data-id="${e.id}" data-bs-toggle="offcanvas" data-bs-target="#offcanvasAddClients" title="Editar"><i class="ti tabler-edit"></i></button><button class="btn btn-sm btn-icon delete-record" data-id="${e.id}" title="Excluir"><i class="ti tabler-trash"></i></button></div>`}}],order:[[1,"desc"]]});document.addEventListener("click",function(t){if(t.target.closest(".view-record")){const n=t.target.closest(".view-record").dataset.id;$("#viewClientModal").modal("show"),$("#clientModalContent").html('<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>'),fetch(`${baseUrl}clients/${n}/quick-view`).then(e=>e.text()).then(e=>{$("#clientModalContent").html(e)})}}),document.addEventListener("click",function(t){if(t.target.closest(".view-vehicle-dossier")){const n=t.target.closest(".view-vehicle-dossier").dataset.id;let e=document.getElementById("viewDossierModal");e||(document.body.insertAdjacentHTML("beforeend",`
                        <div class="modal fade" id="viewDossierModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
                          <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title">Dossiê do Veículo</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body" id="dossierModalContent"></div>
                            </div>
                          </div>
                        </div>`),e=document.getElementById("viewDossierModal")),new bootstrap.Modal(e).show(),document.getElementById("dossierModalContent").innerHTML='<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>',fetch(`${baseUrl}vehicles/${n}/dossier`).then(a=>a.text()).then(a=>{document.getElementById("dossierModalContent").innerHTML=a})}}),document.addEventListener("click",function(t){if(t.target.closest(".delete-record")){const n=t.target.closest(".delete-record").dataset.id;Swal.fire({title:"Excluir cliente?",text:"Isso removerá também o vínculo com veículos!",icon:"warning",showCancelButton:!0,confirmButtonText:"Sim, excluir",customClass:{confirmButton:"btn btn-danger me-3",cancelButton:"btn btn-label-secondary"},buttonsStyling:!1}).then(e=>{e.isConfirmed&&fetch(`${baseUrl}clients-list/${n}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}).then(s=>s.json()).then(s=>{s.success&&(Swal.fire({icon:"success",title:"Excluído!",text:s.message,customClass:{confirmButton:"btn btn-success"}}),m.ajax.reload())})})}}),document.addEventListener("click",function(t){if(t.target.closest(".edit-record")){const n=t.target.closest(".edit-record").dataset.id;document.getElementById("offcanvasAddClientsLabel").innerHTML="Editar Cliente",i.reset(),fetch(`${baseUrl}clients-list/${n}/edit`).then(e=>e.json()).then(e=>{document.getElementById("client_id").value=e.id,e.type==="PF"?(document.getElementById("typePF").checked=!0,d.classList.remove("d-none"),r.classList.add("d-none"),document.querySelector('[name="name"]').value=e.name||"",document.querySelector('[name="cpf"]').value=e.cpf||""):(document.getElementById("typePJ").checked=!0,d.classList.add("d-none"),r.classList.remove("d-none"),document.querySelector('[name="company_name"]').value=e.company_name||"",document.querySelector('[name="cnpj"]').value=e.cnpj||""),document.querySelector('[name="email"]').value=e.email||"",document.querySelector('[name="whatsapp"]').value=e.whatsapp||"",document.querySelector('[name="cep"]').value=e.cep||"",document.querySelector('[name="rua"]').value=e.rua||"",document.querySelector('[name="numero"]').value=e.numero||"",document.querySelector('[name="bairro"]').value=e.bairro||"",document.querySelector('[name="cidade"]').value=e.cidade||"",document.querySelector('[name="estado"]').value=e.estado||"";const s=document.getElementById("existingVehiclesSection"),a=document.getElementById("existingVehiclesList"),o=document.getElementById("vehicleFieldsContainer"),c=document.getElementById("btnToggleVehicle");e.vehicles&&e.vehicles.length>0?(s.classList.remove("d-none"),a.innerHTML=e.vehicles.map(u=>`
                                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                    <div>
                                        <span class="fw-bold text-primary">${u.placa}</span> - 
                                        <small>${u.marca} ${u.modelo}</small>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-label-info btn-icon view-vehicle-dossier" data-id="${u.id}"><i class="ti tabler-eye"></i></button>
                                </div>
                            `).join(""),o.classList.add("d-none"),c.classList.remove("d-none")):(s.classList.add("d-none"),o.classList.remove("d-none"),c.classList.add("d-none"))})}}),document.getElementById("btnToggleVehicle").addEventListener("click",function(){const t=document.getElementById("vehicleFieldsContainer");t.classList.contains("d-none")?(t.classList.remove("d-none"),this.innerHTML='<i class="ti tabler-minus me-1"></i> Ocultar Adição'):(t.classList.add("d-none"),this.innerHTML='<i class="ti tabler-plus me-1"></i> Adicionar Mais')});const l=document.querySelector(".add-new");l&&l.addEventListener("click",()=>{document.getElementById("client_id").value="",document.getElementById("offcanvasAddClientsLabel").innerHTML="Cadastrar Cliente",i.reset(),document.getElementById("typePF").checked=!0,d.classList.remove("d-none"),r.classList.add("d-none"),document.getElementById("existingVehiclesSection").classList.add("d-none"),document.getElementById("vehicleFieldsContainer").classList.remove("d-none"),document.getElementById("btnToggleVehicle").classList.add("d-none")})}i&&i.addEventListener("submit",function(m){m.preventDefault();const l=document.getElementById("client_id").value,t=l?`${baseUrl}clients-list/${l}`:`${baseUrl}clients-list`,n=new FormData(i);n.get("cpf")&&n.set("cpf",n.get("cpf").replace(/\D/g,"")),n.get("cnpj")&&n.set("cnpj",n.get("cnpj").replace(/\D/g,"")),l&&n.append("_method","PUT"),fetch(t,{method:"POST",body:n,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content"),Accept:"application/json"}}).then(async e=>{const s=await e.json();e.ok&&s.success?(bootstrap.Offcanvas.getInstance(b).hide(),Swal.fire({icon:"success",title:"Sucesso!",text:s.message,customClass:{confirmButton:"btn btn-primary"}}).then(()=>{location.reload()})):(i.querySelectorAll(".is-invalid").forEach(a=>a.classList.remove("is-invalid")),i.querySelectorAll(".invalid-feedback").forEach(a=>a.remove()),s.errors?(Object.keys(s.errors).forEach(a=>{const o=i.querySelector(`[name="${a}"]`);if(o){o.classList.add("is-invalid");const c=document.createElement("div");c.className="invalid-feedback",c.innerText=s.errors[a][0],o.closest(".input-group")?o.closest(".input-group").after(c):o.after(c)}}),Swal.fire({icon:"error",title:"Erro de Validação",text:"Por favor, verifique os campos em vermelho.",customClass:{confirmButton:"btn btn-primary"}})):Swal.fire({icon:"error",title:"Erro!",text:s.message||"Erro inesperado",customClass:{confirmButton:"btn btn-primary"}}))}).catch(e=>{Swal.fire({icon:"error",title:"Erro!",text:"Ocorreu um erro ao processar a requisição."})})})});
