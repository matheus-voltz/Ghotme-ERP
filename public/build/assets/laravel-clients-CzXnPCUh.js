console.log("Script laravel-clients.js carregado com sucesso!");document.addEventListener("DOMContentLoaded",function(E){typeof baseUrl>"u"&&(window.baseUrl=window.location.origin+"/"),console.log("Base URL detectada:",baseUrl);const v=document.querySelector(".datatables-clients"),y=document.getElementById("offcanvasAddClients"),l=document.getElementById("addNewClientsForm"),m=document.getElementById("sectionPF"),u=document.getElementById("sectionPJ"),b=document.getElementById("custom-fields-container"),L=document.getElementById("custom-fields-list"),d=i=>{const a=baseUrl.endsWith("/")?baseUrl:baseUrl+"/",c=i.startsWith("/")?i.substring(1):i;return a+c};function g(i){if(!i||i.length===0){b.classList.add("d-none");return}b.classList.remove("d-none"),L.innerHTML=i.map(a=>{const c=a.current_value||"",e=a.required?"required":"";let s="";if(a.type==="select"){const n=Array.isArray(a.options)?a.options:[];s=`
                    <select name="custom_fields[${a.id}]" class="form-select" ${e}>
                        <option value="">Selecione...</option>
                        ${n.map(t=>`<option value="${t}" ${c==t?"selected":""}>${t}</option>`).join("")}
                    </select>`}else a.type==="textarea"?s=`<textarea name="custom_fields[${a.id}]" class="form-control" rows="2" ${e}>${c}</textarea>`:s=`<input type="${a.type}" name="custom_fields[${a.id}]" class="form-control" value="${c}" ${e} />`;return`
                <div class="col-md-12 mb-3">
                    <label class="form-label">${a.name}</label>
                    ${s}
                </div>
            `}).join("")}if(document.querySelectorAll(".client-type-toggle").forEach(i=>{i.addEventListener("change",function(){this.value==="PF"?(m.classList.remove("d-none"),u.classList.add("d-none")):(m.classList.add("d-none"),u.classList.remove("d-none"))})}),v){const i=v.dataset.entities||"Veículos",a=new DataTable(v,{processing:!0,serverSide:!0,ajax:{url:d("clients-list")},columns:[{data:"id"},{data:"id"},{data:"type"},{data:"name"},{data:"document"},{data:"email"},{data:"vehicles_count"},{data:"action"}],columnDefs:[{className:"control",orderable:!1,targets:0,render:()=>""},{targets:2,render:e=>`<span class="badge bg-label-${e==="PF"?"success":"info"}">${e}</span>`},{targets:3,render:(e,s,n)=>`
                            <div class="d-flex flex-column">
                                <span class="fw-medium text-heading">${e}</span>
                                <small class="text-muted">${n.whatsapp||"-"}</small>
                            </div>
                        `},{targets:6,render:e=>`<span class="badge rounded-pill bg-label-primary">${e} ${i.toLowerCase()}</span>`},{targets:7,title:"Ações",orderable:!1,render:(e,s,n)=>{const t=n.whatsapp?`https://api.whatsapp.com/send?phone=55${n.whatsapp.replace(/\D/g,"")}`:"#",o=n.whatsapp?`<a href="${t}" target="_blank" class="btn btn-sm btn-icon text-success" title="WhatsApp"><i class="ti tabler-brand-whatsapp"></i></a>`:"",r=`${baseUrl}portal/${n.uuid}`;return'<div class="d-flex align-items-center gap-2">'+o+`<button class="btn btn-sm btn-icon copy-portal" data-link="${r}" title="Copiar Link do Portal"><i class="ti tabler-link"></i></button><button class="btn btn-sm btn-icon view-record" data-id="${n.id}"><i class="ti tabler-eye"></i></button><button class="btn btn-sm btn-icon edit-record" data-id="${n.id}" data-bs-toggle="offcanvas" data-bs-target="#offcanvasAddClients" title="Editar"><i class="ti tabler-edit"></i></button><button class="btn btn-sm btn-icon delete-record" data-id="${n.id}" title="Excluir"><i class="ti tabler-trash"></i></button></div>`}}],order:[[1,"desc"]]});document.addEventListener("click",function(e){if(e.target.closest(".copy-portal")){const s=e.target.closest(".copy-portal").dataset.link;navigator.clipboard.writeText(s).then(()=>{Swal.fire({icon:"success",title:"Link Copiado!",text:"O link do portal do cliente foi copiado para a área de transferência.",timer:2e3,showConfirmButton:!1})})}}),document.addEventListener("click",function(e){if(e.target.closest(".view-record")){const s=e.target.closest(".view-record").dataset.id;$("#viewClientModal").modal("show"),$("#clientModalContent").html('<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>'),fetch(d(`clients/${s}/quick-view`)).then(n=>n.text()).then(n=>{$("#clientModalContent").html(n)})}}),document.addEventListener("click",function(e){if(e.target.closest(".view-vehicle-dossier")){const s=e.target.closest(".view-vehicle-dossier").dataset.id;let n=document.getElementById("viewDossierModal");n||(document.body.insertAdjacentHTML("beforeend",`
                        <div class="modal fade" id="viewDossierModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
                          <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title">Dossiê do Veículo</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body" id="dossierModalContent"></div>
                            </div>
                          </div>
                        </div>`),n=document.getElementById("viewDossierModal")),new bootstrap.Modal(n).show(),document.getElementById("dossierModalContent").innerHTML='<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>',fetch(d(`vehicles/${s}/dossier`)).then(o=>o.text()).then(o=>{document.getElementById("dossierModalContent").innerHTML=o})}}),document.addEventListener("click",function(e){if(e.target.closest(".delete-record")){const s=e.target.closest(".delete-record").dataset.id;Swal.fire({title:"Excluir cliente?",text:"Isso removerá também o vínculo com veículos!",icon:"warning",showCancelButton:!0,confirmButtonText:"Sim, excluir",customClass:{confirmButton:"btn btn-danger me-3",cancelButton:"btn btn-label-secondary"},buttonsStyling:!1}).then(n=>{n.isConfirmed&&fetch(d(`clients-list/${s}`),{method:"DELETE",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}).then(t=>t.json()).then(t=>{t.success&&(Swal.fire({icon:"success",title:"Excluído!",text:t.message,customClass:{confirmButton:"btn btn-success"}}),a.ajax.reload())})})}}),document.addEventListener("click",function(e){if(e.target.closest(".edit-record")){const s=e.target.closest(".edit-record").dataset.id;document.getElementById("offcanvasAddClientsLabel").innerHTML="Editar Cliente",l.reset(),fetch(d(`clients-list/${s}/edit`)).then(n=>n.json()).then(n=>{const t=n.client;document.getElementById("client_id").value=t.id,t.type==="PF"?(document.getElementById("typePF").checked=!0,m.classList.remove("d-none"),u.classList.add("d-none"),document.querySelector('[name="name"]').value=t.name||"",document.querySelector('[name="cpf"]').value=t.cpf||""):(document.getElementById("typePJ").checked=!0,m.classList.add("d-none"),u.classList.remove("d-none"),document.querySelector('[name="company_name"]').value=t.company_name||"",document.querySelector('[name="cnpj"]').value=t.cnpj||""),document.querySelector('[name="email"]').value=t.email||"",document.querySelector('[name="whatsapp"]').value=t.whatsapp||"",document.querySelector('[name="cep"]').value=t.cep||"",document.querySelector('[name="rua"]').value=t.rua||"",document.querySelector('[name="numero"]').value=t.numero||"",document.querySelector('[name="bairro"]').value=t.bairro||"",document.querySelector('[name="cidade"]').value=t.cidade||"",document.querySelector('[name="estado"]').value=t.estado||"",g(n.custom_fields);const o=document.getElementById("existingVehiclesSection"),r=document.getElementById("existingVehiclesList"),f=document.getElementById("vehicleFieldsContainer"),h=document.getElementById("btnToggleVehicle");t.vehicles&&t.vehicles.length>0?(o.classList.remove("d-none"),r.innerHTML=t.vehicles.map(p=>`
                                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                    <div>
                                        <span class="fw-bold text-primary">${p.placa}</span> - 
                                        <small>${p.marca} ${p.modelo}</small>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-label-info btn-icon view-vehicle-dossier" data-id="${p.id}"><i class="ti tabler-eye"></i></button>
                                </div>
                            `).join(""),f.classList.add("d-none"),h.classList.remove("d-none")):(o.classList.add("d-none"),f.classList.remove("d-none"),h.classList.add("d-none"))})}}),document.getElementById("btnToggleVehicle").addEventListener("click",function(){const e=document.getElementById("vehicleFieldsContainer");e.classList.contains("d-none")?(e.classList.remove("d-none"),this.innerHTML='<i class="ti tabler-minus me-1"></i> Ocultar Adição'):(e.classList.add("d-none"),this.innerHTML='<i class="ti tabler-plus me-1"></i> Adicionar Mais')});const c=document.querySelector(".add-new");c&&c.addEventListener("click",()=>{document.getElementById("client_id").value="",document.getElementById("offcanvasAddClientsLabel").innerHTML="Cadastrar Cliente",l.reset(),document.getElementById("typePF").checked=!0,m.classList.remove("d-none"),u.classList.add("d-none"),console.log("Buscando campos para novo cliente..."),fetch(d("settings/custom-fields?entity=Clients")).then(e=>(console.log("Resposta do servidor recebida:",e.status),e.json())).then(e=>{console.log("Campos recebidos:",e),g(e)}).catch(e=>{console.error("Erro ao buscar campos personalizados:",e),b.classList.add("d-none")}),document.getElementById("existingVehiclesSection").classList.add("d-none"),document.getElementById("vehicleFieldsContainer").classList.remove("d-none"),document.getElementById("btnToggleVehicle").classList.add("d-none")})}l&&l.addEventListener("submit",function(i){i.preventDefault();const a=document.getElementById("client_id").value,c=d(a?`clients-list/${a}`:"clients-list"),e=new FormData(l);e.get("cpf")&&e.set("cpf",e.get("cpf").replace(/\D/g,"")),e.get("cnpj")&&e.set("cnpj",e.get("cnpj").replace(/\D/g,"")),a&&e.append("_method","PUT"),fetch(c,{method:"POST",body:e,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content"),Accept:"application/json"}}).then(async s=>{const n=await s.json();s.ok&&n.success?(bootstrap.Offcanvas.getInstance(y).hide(),Swal.fire({icon:"success",title:"Sucesso!",text:n.message,customClass:{confirmButton:"btn btn-primary"}}).then(()=>{location.reload()})):(l.querySelectorAll(".is-invalid").forEach(t=>t.classList.remove("is-invalid")),l.querySelectorAll(".invalid-feedback").forEach(t=>t.remove()),n.errors?Object.keys(n.errors).forEach(t=>{const o=l.querySelector(`[name="${t}"]`);if(o){o.classList.add("is-invalid");const r=document.createElement("div");r.className="invalid-feedback",r.innerText=n.errors[t][0],o.closest(".input-group")?o.closest(".input-group").after(r):o.after(r)}}):Swal.fire({icon:"error",title:"Erro!",text:n.message||"Erro inesperado"}))}).catch(s=>{Swal.fire({icon:"error",title:"Erro!",text:"Ocorreu um erro ao processar a requisição."})})})});
