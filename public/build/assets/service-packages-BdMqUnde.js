document.addEventListener("DOMContentLoaded",function(u){const d=document.querySelector(".datatables-packages"),m=document.getElementById("offcanvasPackage"),o=document.getElementById("formPackage"),l=$("#add-part-select"),i=document.getElementById("selected-parts-list");if($(".select2").each(function(){var s=$(this);s.wrap('<div class="position-relative"></div>').select2({dropdownParent:s.parent(),placeholder:s.attr("placeholder")||"Selecione"})}),d){let s=function(e,n,t){if(document.getElementById(`part-row-${e}`))return;const a=document.createElement("div");a.id=`part-row-${e}`,a.className="d-flex align-items-center mb-2 gap-2 border p-2 rounded",a.innerHTML=`
                <input type="hidden" name="parts[]" value="${e}">
                <div class="flex-grow-1"><small>${n}</small></div>
                <div style="width: 80px">
                    <input type="number" name="parts_qty[${e}]" class="form-control form-control-sm" value="${t}" min="1">
                </div>
                <button type="button" class="btn btn-sm btn-icon text-danger remove-part"><i class="ti tabler-x"></i></button>
            `,i.appendChild(a)};var p=s;new DataTable(d,{processing:!0,serverSide:!0,ajax:{url:baseUrl+"services/packages-list"},columns:[{data:"fake_id"},{data:"name"},{data:"id"},{data:"total_price"},{data:"is_active"},{data:"action"}],columnDefs:[{targets:1,render:function(e){return`<span class="fw-medium text-heading">${e}</span>`}},{targets:2,render:function(e,n,t){return`<small>${t.services_count} serv. / ${t.parts_count} peças</small>`}},{targets:3,render:function(e){return e?`R$ ${parseFloat(e).toFixed(2)}`:'<span class="text-muted">Calculado</span>'}},{targets:4,className:"text-center",render:function(e){return e?'<span class="badge bg-label-success">Ativo</span>':'<span class="badge bg-label-danger">Inativo</span>'}},{targets:5,title:"Ações",orderable:!1,render:function(e,n,t){return`<div class="d-flex align-items-center gap-2"><button class="btn btn-sm btn-icon edit-record" data-id="${t.id}" data-bs-toggle="offcanvas" data-bs-target="#offcanvasPackage"><i class="ti tabler-edit"></i></button><button class="btn btn-sm btn-icon delete-record" data-id="${t.id}"><i class="ti tabler-trash"></i></button></div>`}}],layout:{topEnd:{features:[{search:{placeholder:"Procurar pacote"}},{buttons:[{text:'<i class="ti tabler-plus me-1"></i> Criar Pacote',className:"add-new btn btn-primary",attr:{"data-bs-toggle":"offcanvas","data-bs-target":"#offcanvasPackage"}}]}]}}}),l.on("select2:select",function(e){const n=e.params.data.id,t=$(e.params.data.element).data("name");n&&(s(n,t,1),l.val(null).trigger("change"))}),document.addEventListener("click",function(e){e.target.closest(".remove-part")&&e.target.closest(".remove-part").parentElement.remove()}),document.addEventListener("click",function(e){if(e.target.closest(".edit-record")){const n=e.target.closest(".edit-record").dataset.id;document.getElementById("offcanvasPackageLabel").innerHTML="Editar Pacote",i.innerHTML="",fetch(`${baseUrl}services/packages/${n}/edit`).then(t=>t.json()).then(t=>{document.getElementById("package_id").value=t.id,document.getElementById("package-name").value=t.name,document.getElementById("package-total-price").value=t.total_price||"",document.getElementById("package-description").value=t.description||"";const a=t.services.map(r=>r.id);$("#package-services").val(a).trigger("change"),t.parts.forEach(r=>{s(r.id,r.name,r.pivot.quantity)})})}});const c=document.querySelector(".add-new");c&&c.addEventListener("click",function(){document.getElementById("package_id").value="",document.getElementById("offcanvasPackageLabel").innerHTML="Novo Pacote",o.reset(),$("#package-services").val(null).trigger("change"),i.innerHTML=""})}o&&o.addEventListener("submit",function(s){s.preventDefault();const c=new FormData(o),e=c.get("id"),n=e?`${baseUrl}services/packages/${e}`:`${baseUrl}services/packages`;fetch(n,{method:e?"PUT":"POST",body:new URLSearchParams(c),headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"Content-Type":"application/x-www-form-urlencoded"}}).then(a=>a.json()).then(a=>{a.success&&(bootstrap.Offcanvas.getInstance(m).hide(),new DataTable(d).draw(),Swal.fire({icon:"success",title:"Sucesso!",text:a.message,customClass:{confirmButton:"btn btn-success"}}))})})});
