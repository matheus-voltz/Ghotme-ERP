document.addEventListener("DOMContentLoaded",function(v){const d=document.querySelector(".datatables-vehicles"),u=document.getElementById("offcanvasAddVehicles"),n=document.getElementById("addNewVehicleForm");var l=$(".select2");l.length&&l.wrap('<div class="position-relative"></div>').select2({placeholder:"Selecione o Cliente",dropdownParent:l.parent()});const m=document.getElementById("add-vehicle-placa");if(m&&m.addEventListener("blur",function(){const i=this.value.replace(/[^a-zA-Z0-9]/g,"");if(i.length>=7){const c=this.placeholder;this.placeholder="Buscando...",fetch(`${baseUrl}api/vehicle-lookup/${i}`).then(e=>e.json()).then(e=>{this.placeholder=c,!e.error&&!e.message&&(e.marca&&(document.getElementById("add-vehicle-marca").value=e.marca),e.modelo&&(document.getElementById("add-vehicle-modelo").value=e.modelo),e.ano&&(document.getElementById("add-vehicle-ano-fabricacao").value=e.ano))}).catch(()=>{this.placeholder=c})}}),d){const i=new DataTable(d,{processing:!0,serverSide:!0,ajax:{url:baseUrl+"vehicles-list"},columns:[{data:"id"},{data:"id"},{data:"placa"},{data:"marca"},{data:"modelo"},{data:"ano_fabricacao"},{data:"ativo"},{data:"id"}],columnDefs:[{className:"control",orderable:!1,targets:0,render:()=>""},{targets:1,render:(e,a,t)=>`<span>${t.fake_id}</span>`},{targets:2,render:(e,a,t)=>`<a href="javascript:void(0)" class="fw-bold text-primary view-dossier" data-id="${t.id}">${e}</a>`},{targets:6,render:e=>`<span class="badge bg-label-${e?"success":"danger"}">${e?"Sim":"Não"}</span>`},{targets:-1,title:"Ações",orderable:!1,render:(e,a,t)=>`<div class="d-flex align-items-center gap-2"><button class="btn btn-sm btn-icon edit-record" data-id="${t.id}" data-bs-toggle="offcanvas" data-bs-target="#offcanvasAddVehicles"><i class="ti tabler-edit"></i></button><button class="btn btn-sm btn-icon delete-record" data-id="${t.id}"><i class="ti tabler-trash"></i></button></div>`}],order:[[1,"desc"]]});document.addEventListener("click",function(e){if(e.target.closest(".view-dossier")){const a=e.target.closest(".view-dossier").dataset.id;$("#viewDossierModal").modal("show"),$("#dossierModalContent").html('<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>'),fetch(`${baseUrl}vehicles/${a}/dossier`).then(t=>t.text()).then(t=>{$("#dossierModalContent").html(t)})}}),document.addEventListener("click",function(e){if(e.target.closest(".delete-record")){const a=e.target.closest(".delete-record").dataset.id;Swal.fire({title:"Remover veículo?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sim, excluir",customClass:{confirmButton:"btn btn-danger me-3",cancelButton:"btn btn-label-secondary"},buttonsStyling:!1}).then(t=>{t.isConfirmed&&fetch(`${baseUrl}vehicles-list/${a}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}).then(()=>i.ajax.reload())})}}),document.addEventListener("click",function(e){if(e.target.closest(".edit-record")){const a=e.target.closest(".edit-record").dataset.id;document.getElementById("offcanvasAddVehiclesLabel").innerHTML="Editar Veículo",fetch(`${baseUrl}vehicles-list/${a}/edit`).then(t=>t.json()).then(t=>{document.getElementById("vehicle_id").value=t.id,document.getElementById("add-vehicle-placa").value=t.placa,document.getElementById("add-vehicle-marca").value=t.marca,document.getElementById("add-vehicle-modelo").value=t.modelo,document.getElementById("add-vehicle-ano-fabricacao").value=t.ano_fabricacao||"",document.getElementById("add-vehicle-renavam").value=t.renavam||"",$("#vehicle-cliente").val(t.cliente_id).trigger("change"),$("#vehicle-status").val(t.ativo?"1":"0")})}});const c=document.querySelector(".add-new");c&&c.addEventListener("click",()=>{document.getElementById("vehicle_id").value="",n.reset(),$("#vehicle-cliente").val("").trigger("change"),document.getElementById("offcanvasAddVehiclesLabel").innerHTML="Cadastrar Veículo"})}n&&n.addEventListener("submit",function(i){i.preventDefault();const c=new FormData(n);fetch(`${baseUrl}vehicles-list`,{method:"POST",body:c,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content"),Accept:"application/json"}}).then(async e=>{const a=await e.json();e.ok&&a.success?(bootstrap.Offcanvas.getInstance(u).hide(),Swal.fire({icon:"success",title:"Sucesso!",text:a.message,customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}).then(()=>{location.reload()})):(n.querySelectorAll(".is-invalid").forEach(t=>t.classList.remove("is-invalid")),n.querySelectorAll(".invalid-feedback").forEach(t=>t.remove()),a.errors?Object.keys(a.errors).forEach(t=>{const s=n.querySelector(`[name="${t}"]`);if(s){s.classList.add("is-invalid");const o=document.createElement("div");if(o.className="invalid-feedback",o.innerText=a.errors[t][0],s.closest(".input-group"))s.closest(".input-group").after(o);else if(s.classList.contains("select2-hidden-accessible")){const r=s.nextElementSibling;r&&r.classList.contains("select2-container")&&r.after(o)}else s.after(o)}}):Swal.fire({icon:"error",title:"Erro!",text:a.message||"Erro inesperado"}))}).catch(e=>{Swal.fire({icon:"error",title:"Erro!",text:"Ocorreu um erro ao processar a requisição."})})})});
